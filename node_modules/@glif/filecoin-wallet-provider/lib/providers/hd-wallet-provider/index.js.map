{"version":3,"sources":["../../../src/providers/hd-wallet-provider/index.ts"],"names":["CoinType","Message","signingTools","createPath","coinTypeCode","validIndexes","errors","InvalidParamsError","WalletProviderError","HDWalletProvider","seed","nStart","nEnd","coinType","MAIN","message","TEST","accounts","i","path","account","keyDerive","address","push","accountToPath","from","From","msg","fromLotusType","Error","undefined","private_hexstring","transactionSign","toZondaxType","Buffer","toString","signature","Signature","Type","type","Data","data"],"mappings":"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","sourcesContent":["import { CoinType } from '@glif/filecoin-address'\nimport {\n  Message,\n  SignedLotusMessage,\n  LotusMessage,\n} from '@glif/filecoin-message'\nimport signingTools from '@zondax/filecoin-signing-tools/js'\nimport { WalletType } from '../../types'\nimport { WalletSubProvider } from '../../wallet-sub-provider'\nimport { createPath, coinTypeCode, validIndexes } from '../../utils'\nimport { errors } from '../../errors'\n\nconst { InvalidParamsError, WalletProviderError } = errors\n\nexport class HDWalletProvider implements WalletSubProvider {\n  public type: WalletType = 'HD_WALLET'\n  private accountToPath: Record<string, string> = {}\n  #seed: string\n  constructor(seed: string) {\n    if (!seed) throw new InvalidParamsError()\n    this.#seed = seed\n  }\n\n  getAccounts = async (\n    nStart = 0,\n    nEnd = 5,\n    coinType = CoinType.MAIN,\n  ): Promise<string[]> => {\n    if (!validIndexes(nStart, nEnd)) {\n      throw new InvalidParamsError({\n        message: 'Invalid indexes provided to getAccounts',\n      })\n    }\n\n    if (coinType !== CoinType.MAIN && coinType !== CoinType.TEST) {\n      throw new InvalidParamsError({\n        message: 'Invalid coinType passed to getAccounts',\n      })\n    }\n\n    const accounts = []\n    for (let i = nStart; i < nEnd; i += 1) {\n      const path = createPath(coinTypeCode(coinType), i)\n      const account = signingTools.keyDerive(this.#seed, path, '').address\n      accounts.push(account)\n      this.accountToPath[account] = path\n    }\n    return accounts\n  }\n\n  sign = async (\n    from: string,\n    message: LotusMessage,\n  ): Promise<SignedLotusMessage> => {\n    if (from !== message.From) {\n      throw new InvalidParamsError({ message: 'From address mismatch' })\n    }\n    const path = this.accountToPath[from]\n    if (!path) {\n      throw new WalletProviderError({\n        message: 'Account was not yet derived from this seed phrase',\n      })\n    }\n    let msg\n    try {\n      msg = Message.fromLotusType(message)\n    } catch (err) {\n      throw new InvalidParamsError(\n        err instanceof Error\n          ? {\n              message: `Invalid message params passed to sign call: ${err.message}`,\n            }\n          : undefined,\n      )\n    }\n\n    const { private_hexstring } = signingTools.keyDerive(this.#seed, path, '')\n    const { signature } = signingTools.transactionSign(\n      msg.toZondaxType(),\n      Buffer.from(private_hexstring, 'hex').toString('base64'),\n    ) as { signature: { data: string; type: number } }\n\n    return {\n      Message: message,\n      Signature: {\n        Type: signature.type,\n        Data: signature.data,\n      },\n    }\n  }\n}\n"],"file":"index.js"}