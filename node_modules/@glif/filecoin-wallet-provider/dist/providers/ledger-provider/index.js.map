{"version":3,"sources":["../../../src/providers/ledger-provider/index.ts"],"names":["LedgerLostConnectionError","errors","LedgerDeviceLockedError","LedgerFilecoinAppBadVersionError","LedgerReplugError","LedgerDeviceBusyError","WalletProviderError","handleLedgerResponseErrors","response","device_locked","error_message","toLowerCase","includes","message","throwIfBusy","busy","LedgerProvider","transport","minLedgerVersion","ledgerBusy","Promise","resolve","reject","finished","setTimeout","FilecoinApp","getVersion","vs","major","minor","patch","Error","from","From","InvalidParamsError","path","accountToPath","msg","Message","fromLotusType","undefined","serializedMessage","signingTools","transactionSerialize","toZondaxType","sign","Buffer","res","signedMessage","Signature","Data","signature_compact","toString","Type","nStart","nEnd","coinType","CoinType","MAIN","TEST","paths","i","push","getAddressAndPubKey","addrString","addresses","showAddressAndPubKey","_transport"],"mappings":"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","sourcesContent":["import { CoinType } from '@glif/filecoin-address'\nimport FilecoinApp from '@zondax/ledger-filecoin'\nimport Transport from '@ledgerhq/hw-transport'\nimport { mapSeries } from 'bluebird'\nimport {\n  LotusMessage,\n  Message,\n  SignedLotusMessage,\n} from '@glif/filecoin-message'\nimport signingTools from '@zondax/filecoin-signing-tools/js'\nimport { createPath, coinTypeCode, validIndexes } from '../../utils'\nimport { SemanticVersion, WalletType } from '../../types'\nimport { WalletSubProvider } from '../../wallet-sub-provider'\nimport { CommonLedgerError, errors } from '../../errors'\n\nconst {\n  LedgerLostConnectionError,\n  LedgerDeviceLockedError,\n  LedgerFilecoinAppBadVersionError,\n  LedgerReplugError,\n  LedgerDeviceBusyError,\n  WalletProviderError,\n} = errors\n\nimport { badVersion } from './badVersion'\n\ntype LedgerResponse = {\n  return_code: number\n  error_message: string\n  device_locked: boolean\n}\n\nexport type LedgerVersion = LedgerResponse &\n  SemanticVersion & {\n    test_mode: boolean\n    target_id: string\n  }\n\nexport type LedgerShowAddrAndPubKey = LedgerResponse & {\n  addrString: string\n}\n\nexport type LedgerSignature = LedgerResponse & {\n  signature_compact: Buffer\n}\n\nexport type LedgerSubProvider = WalletSubProvider & {\n  getVersion: () => Promise<LedgerVersion>\n  showAddressAndPubKey: (_: string) => Promise<LedgerShowAddrAndPubKey>\n  resetTransport: (_: Transport) => Promise<void>\n  ready: () => Promise<boolean>\n}\n\nfunction handleLedgerResponseErrors(response: LedgerResponse): LedgerResponse {\n  if (response.device_locked) {\n    throw new LedgerDeviceLockedError()\n  }\n\n  if (\n    response.error_message &&\n    response.error_message.toLowerCase().includes('no errors')\n  ) {\n    return response\n  }\n  if (\n    response.error_message &&\n    response.error_message\n      .toLowerCase()\n      .includes('transporterror: invalid channel')\n  ) {\n    throw new LedgerLostConnectionError()\n  }\n\n  throw new WalletProviderError({ message: response.error_message })\n}\n\nconst throwIfBusy = (busy: boolean): void => {\n  if (busy) throw new LedgerDeviceBusyError()\n}\n\nexport class LedgerProvider implements LedgerSubProvider {\n  public type: WalletType = 'LEDGER'\n  public ledgerBusy: boolean = false\n  public minLedgerVersion: SemanticVersion\n  private transport: Transport\n  private accountToPath: Record<string, string> = {}\n\n  constructor({\n    transport,\n    minLedgerVersion,\n  }: {\n    transport: Transport\n    minLedgerVersion: SemanticVersion\n  }) {\n    if (!transport)\n      throw new errors.InvalidParamsError({\n        message: 'Must provide transport when instantiating LedgerSubProvider',\n      })\n    if (\n      !minLedgerVersion ||\n      typeof minLedgerVersion.major !== 'number' ||\n      typeof minLedgerVersion.minor !== 'number' ||\n      typeof minLedgerVersion.patch !== 'number'\n    )\n      throw new errors.InvalidParamsError({\n        message: 'Must provide valid minLedgerVersions',\n      })\n\n    this.transport = transport\n    this.minLedgerVersion = minLedgerVersion\n  }\n\n  /**\n   * getVersion call rejects if it takes too long to respond,\n   * meaning the Ledger device is locked\n   */\n  getVersion = (): Promise<LedgerVersion> => {\n    throwIfBusy(this.ledgerBusy)\n    this.ledgerBusy = true\n    return new Promise((resolve, reject) => {\n      let finished = false\n      setTimeout(() => {\n        if (!finished) {\n          finished = true\n          this.ledgerBusy = false\n          return reject(new LedgerDeviceBusyError())\n        }\n      }, 3000)\n\n      setTimeout(async () => {\n        try {\n          const vs = handleLedgerResponseErrors(\n            (await new FilecoinApp(\n              this.transport,\n            ).getVersion()) as LedgerVersion,\n          ) as LedgerVersion\n\n          if (badVersion(this.minLedgerVersion, vs))\n            throw new LedgerFilecoinAppBadVersionError({\n              message: `\n              Filecoin App on Ledger device should be version\n              ${this.minLedgerVersion.major}.${this.minLedgerVersion.minor}.${this.minLedgerVersion.patch}\n            `,\n            })\n          return resolve(vs)\n        } catch (err) {\n          return reject(err)\n        } finally {\n          if (!finished) {\n            finished = true\n            this.ledgerBusy = false\n          }\n        }\n      })\n    })\n  }\n\n  ready = async (): Promise<boolean> => {\n    try {\n      // tslint:disable-next-line no-unused-expression\n      handleLedgerResponseErrors(await this.getVersion()) as LedgerVersion\n    } catch (err) {\n      if (err instanceof Error) {\n        throw CommonLedgerError(err)\n      } else {\n        throw new LedgerReplugError()\n      }\n    }\n    return true\n  }\n\n  sign = async (\n    from: string,\n    message: LotusMessage,\n  ): Promise<SignedLotusMessage> => {\n    throwIfBusy(this.ledgerBusy)\n    if (from !== message.From)\n      throw new errors.InvalidParamsError({ message: 'from address mismatch' })\n    this.ledgerBusy = true\n    const path = this.accountToPath[from]\n    if (!path) {\n      this.ledgerBusy = false\n      throw new errors.WalletProviderError({\n        message:\n          'Must call getAccounts with to derive this from address before signing with it',\n      })\n    }\n    let msg: Message\n    try {\n      msg = Message.fromLotusType(message)\n    } catch (err) {\n      throw new errors.InvalidParamsError(\n        err instanceof Error\n          ? {\n              message: `Invalid message params passed to sign call: ${err.message}`,\n            }\n          : undefined,\n      )\n    } finally {\n      this.ledgerBusy = false\n    }\n    const serializedMessage = signingTools.transactionSerialize(\n      msg.toZondaxType(),\n    )\n    try {\n      const res = handleLedgerResponseErrors(\n        await new FilecoinApp(this.transport).sign(\n          path,\n          Buffer.from(serializedMessage, 'hex'),\n        ),\n      ) as LedgerSignature\n      const signedMessage: SignedLotusMessage = {\n        Message: message,\n        Signature: {\n          Data: res.signature_compact.toString('base64'),\n          Type: 1,\n        },\n      }\n      return signedMessage\n    } catch (err) {\n      if (err instanceof Error) {\n        throw CommonLedgerError(err)\n      } else {\n        throw new LedgerReplugError()\n      }\n    } finally {\n      this.ledgerBusy = false\n    }\n  }\n\n  getAccounts = async (nStart = 0, nEnd = 5, coinType = CoinType.MAIN) => {\n    throwIfBusy(this.ledgerBusy)\n    if (!validIndexes(nStart, nEnd)) {\n      throw new errors.InvalidParamsError({\n        message: 'invalid account indexes passed to getAccounts',\n      })\n    }\n\n    if (coinType !== CoinType.MAIN && coinType !== CoinType.TEST) {\n      throw new errors.InvalidParamsError({\n        message: 'invalid coinType passed to getAccounts',\n      })\n    }\n\n    this.ledgerBusy = true\n    const paths: string[] = []\n    for (let i = nStart; i < nEnd; i += 1) {\n      paths.push(createPath(coinTypeCode(coinType), i))\n    }\n    const addresses = await mapSeries(paths, async (path: string) => {\n      try {\n        const { addrString } = handleLedgerResponseErrors(\n          await new FilecoinApp(this.transport).getAddressAndPubKey(path),\n        ) as LedgerShowAddrAndPubKey\n        this.accountToPath[addrString] = path\n        return addrString\n      } catch (err) {\n        if (err instanceof Error) {\n          throw CommonLedgerError(err)\n        } else {\n          throw new LedgerReplugError()\n        }\n      } finally {\n        this.ledgerBusy = false\n      }\n    })\n    this.ledgerBusy = false\n    return addresses\n  }\n\n  showAddressAndPubKey = async (\n    path: string,\n  ): Promise<LedgerShowAddrAndPubKey> => {\n    throwIfBusy(this.ledgerBusy)\n    this.ledgerBusy = true\n    try {\n      const res = handleLedgerResponseErrors(\n        await new FilecoinApp(this.transport).showAddressAndPubKey(path),\n      ) as LedgerShowAddrAndPubKey\n      return res\n    } catch (err) {\n      if (err instanceof Error) {\n        throw CommonLedgerError(err)\n      } else {\n        throw new LedgerReplugError()\n      }\n    } finally {\n      this.ledgerBusy = false\n    }\n  }\n\n  resetTransport = async (_transport: Transport): Promise<void> => {\n    this.transport = _transport\n  }\n}\n"],"file":"index.js"}