{"version":3,"sources":["../../../src/providers/metamask-provider/index.ts"],"names":["MetaMaskProvider","snap","nStart","nEnd","coinType","CoinType","MAIN","errors","InvalidParamsError","message","TEST","paths","i","push","path","configure","derivationPath","network","getAddress","account","accountToPath","MetaMaskError","Error","addresses","from","From","WalletProviderError","msg","Message","fromLotusType","undefined","signMessage","toZondaxType","signReq","confirmed","TransactionRejectedError","error","Signature","Data","signedMessage","signature","data","Type","type"],"mappings":"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","sourcesContent":["import { FilecoinSnapApi } from '@chainsafe/filsnap-types'\nimport { CoinType } from '@glif/filecoin-address'\nimport {\n  LotusMessage,\n  Message,\n  SignedLotusMessage,\n  ZondaxMessage,\n} from '@glif/filecoin-message'\nimport { mapSeries } from 'bluebird'\nimport { WalletType } from '../../types'\nimport { errors } from '../../errors'\nimport { WalletSubProvider } from '../../wallet-sub-provider'\nimport {\n  coinTypeCode,\n  createPath,\n  validIndexes,\n  extractCoinTypeFromPath,\n} from '../../utils'\n\nexport class MetaMaskProvider implements WalletSubProvider {\n  public type: WalletType = 'METAMASK'\n  private snap: FilecoinSnapApi\n  private accountToPath: Record<string, string> = {}\n\n  constructor({ snap }: { snap: FilecoinSnapApi }) {\n    if (!snap)\n      throw new errors.InvalidParamsError({\n        message: 'Must pass `snap` to MetaMask provider',\n      })\n    this.snap = snap\n  }\n\n  getAccounts = async (nStart = 0, nEnd = 5, coinType = CoinType.MAIN) => {\n    if (!validIndexes(nStart, nEnd)) {\n      throw new errors.InvalidParamsError({\n        message: 'invalid account indexes passed to getAccounts',\n      })\n    }\n\n    if (coinType !== CoinType.MAIN && coinType !== CoinType.TEST) {\n      throw new errors.InvalidParamsError({\n        message: 'invalid coinType passed to getAccounts',\n      })\n    }\n    try {\n      const paths: string[] = []\n      for (let i = nStart; i < nEnd; i += 1) {\n        paths.push(createPath(coinTypeCode(coinType), i))\n      }\n      const addresses = await mapSeries(paths, async (path: string) => {\n        try {\n          await this.snap.configure({ derivationPath: path, network: coinType })\n          const account = await this.snap.getAddress()\n          this.accountToPath[account] = path\n          return account\n        } catch (err) {\n          throw new errors.MetaMaskError({\n            message:\n              err instanceof Error\n                ? err.message\n                : 'Error getting accounts from MetaMask',\n          })\n        }\n      })\n      return addresses\n    } catch (err) {\n      throw new errors.MetaMaskError({\n        message:\n          err instanceof Error\n            ? err.message\n            : 'Error getting accounts from MetaMask',\n      })\n    }\n  }\n\n  sign = async (\n    from: string,\n    message: LotusMessage,\n  ): Promise<SignedLotusMessage> => {\n    if (from !== message.From) {\n      throw new errors.InvalidParamsError({ message: 'From address mismatch' })\n    }\n    const path = this.accountToPath[from]\n    if (!path) {\n      throw new errors.WalletProviderError({\n        message:\n          'Must call getAccounts with to derive this from address before signing with it',\n      })\n    }\n\n    try {\n      await this.snap.configure({\n        derivationPath: path,\n        network: extractCoinTypeFromPath(path),\n      })\n    } catch (err) {\n      throw new errors.MetaMaskError({\n        message: err instanceof Error ? err.message : 'Error configuring snap',\n      })\n    }\n\n    let msg: Message\n    try {\n      msg = Message.fromLotusType(message)\n    } catch (err) {\n      throw new errors.InvalidParamsError(\n        err instanceof Error\n          ? {\n              message: `Invalid message params passed to sign call: ${err.message}`,\n            }\n          : undefined,\n      )\n    }\n\n    const signReq = await this.snap.signMessage(\n      msg.toZondaxType() as ZondaxMessage & { params: string },\n    )\n\n    if (!signReq)\n      throw new errors.MetaMaskError({ message: 'Error signing transaction' })\n    if (!signReq.confirmed) throw new errors.TransactionRejectedError()\n    if (signReq.error)\n      throw new errors.MetaMaskError({\n        message: signReq.error.message,\n      })\n\n    return {\n      Message: message,\n      Signature: {\n        Data: signReq.signedMessage?.signature?.data,\n        Type: signReq.signedMessage?.signature?.type,\n      },\n    }\n  }\n}\n"],"file":"index.js"}